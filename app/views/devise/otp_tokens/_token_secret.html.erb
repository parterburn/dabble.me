<% current_user.generate_otp_secret unless current_user.otp_auth_secret? %>

<% unless current_user.otp_enabled? %>
  <hr>
  <p style="margin-bottom: 5px;"><label><%= I18n.t('explain', :scope => 'devise.otp.token_secret') %></label></p>
  <div style="margin-bottom: 20px;"><%= otp_authenticator_token_image(current_user) %></div>
<% end %>

<% if current_user.otp_enabled? %>
  <%- if recovery_enabled? && current_user.otp_enabled_on > 10.minutes.ago %>
    <div class="alert alert-info force-links" style="margin: 20px auto;">
      <h4><%= I18n.t('title', :scope => 'devise.otp.otp_tokens.recovery') %></h4>
      <p><%= I18n.t('explain', :scope => 'devise.otp.otp_tokens.recovery') %></p>
      <p>
        <div style="margin-bottom: 10px;">
          <div id="recovery-codes" style="margin-bottom: 5px; font-family: monospace;">
            <%- current_user.next_otp_recovery_tokens.each do |seq, code| %>
              <%= code %><br/>
            <% end %>
          </div>
          <button type="button" class="btn btn-default btn-xs j-copy-to-clipboard" data-content="<%= current_user.next_otp_recovery_tokens.map { |_, code| code }.join("\n") %>">
            <i class="fa fa-copy"></i> Copy to clipboard
          </button>
        </div>
        <%= link_to I18n.t('download_codes', :scope => 'devise.otp.otp_tokens.recovery'), recovery_otp_token_for(resource_name, format: :text) %>
      </p>
    </div>
  <% else %>
  <hr>
  <% end %>

  <%= render :partial => 'trusted_devices' if trusted_devices_enabled? %>
  <hr>
  <p>
    <%= I18n.t('reset_explain', :scope => 'devise.otp.token_secret') %>
    <strong><%= I18n.t('reset_explain_warn', :scope => 'devise.otp.token_secret') %></strong>
  </p>
  <p><%= button_to I18n.t('reset_otp', :scope => 'devise.otp.token_secret'), @resource, :method => :delete, :data => { "turbo-method": "DELETE" }, class: "btn btn-danger" %></p>  
<% else %>
    <%= form_for(current_user, :as => resource_name, :url => validate_otp_path, :html => { :method => :post, "data-turbo" => false }) do |f| %>

      <%= f.hidden_field :challenge, {:value => @challenge} %>
      <%= f.hidden_field :recovery, {:value => @recovery} %>

      <% if @recovery %>
        <p>
          <%= f.label :token, I18n.t('recovery_prompt', :scope => 'devise.otp.submit_token') %><br />
          <%= f.text_field :otp_recovery_counter, :autocomplete => :off, :disabled => true, :size => 4, class: "form-control" %>
        </p>
      <% else %>
        <p>
          <%= f.label :token, "Step 2: #{I18n.t('prompt', :scope => 'devise.otp.submit_token')}" %><br />
        </p>
      <% end %>

      <%= f.text_field :token, :autocomplete => :off, :autofocus => true, :size => 6, :value => '', class: "form-control" %><br>
      <%= f.submit "Enable Two-Factor Authentication", class: "btn btn-primary form-control" %><br>
    <% end %>
<% end %>
